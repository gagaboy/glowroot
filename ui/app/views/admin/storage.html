<!--
  Copyright 2013-2019 the original author or authors.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->
<!-- id is used for auto focus, see storage.js -->
<div class="card" id="storageConfigCard">
  <div class="card-header">
    <h2>存储</h2>
  </div>
  <div class="card-body">
    <div ng-include src="'template/gt-loading-overlay.html'"></div>
    <div ng-include src="'template/gt-http-error-overlay.html'"></div>
    <!-- not using gt-form-autofocus-on-first-input in order to handle special case #rollup-detail-capped-size
         and trace-detail-capped-size urls (see storage.js) -->
    <div ng-form
         name="formCtrl">
      <fieldset class="gt-fieldset"
                ng-if="!layout.central">
        <legend class="gt-legend">
          data.h2.db
        </legend>
        <div gt-form-group
             gt-label="响应时间和JVM指标数据 (1&nbsp;分钟&nbsp;聚合)"
             gt-model="page.rollupExpirationDays[0]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            在事务响应时间选项卡下和JVM指标屏幕上显示的数据将被连续收集并以1分钟的间隔存储。 此设置定义保留这些1分钟聚合的时间。 （此设置也适用于5秒计量数据）
          </div>
        </div>
        <div gt-form-group
             gt-label="响应时间和JVM指标仪表数据 (5&nbsp;分钟&nbsp;聚合)"
             gt-model="page.rollupExpirationDays[1]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔5分钟汇总一次。此设置定义这些5分钟聚合数据的保存时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="响应时间和JVM指标数据 (30&nbsp;分钟&nbsp;聚合)"
             gt-model="page.rollupExpirationDays[2]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔30分钟再次汇总。此设置定义保留这30分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="响应时间和JVM指标数据 (4&nbsp;小时&nbsp;聚合)"
             gt-model="page.rollupExpirationDays[3]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔4小时再次汇总。此设置定义保留这4小时聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="跟踪数据"
             gt-model="page.traceExpirationDays"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            此设置定义保留事务跟踪选项卡下显示的跟踪点和跟踪标头数据的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="完整查询文本"
             gt-model="page.fullQueryTextExpirationDays"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="days"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            此设置定义保留事务查询选项卡下显示的完整查询文本的时间。 根据以下* .capped.db设置保留截断的查询文本和查询统计信息。
          </div>
        </div>
      </fieldset>
      <fieldset class="gt-fieldset"
                ng-if="!layout.central">
        <legend class="gt-legend">
          *.capped.db
        </legend>
        <div gt-form-group
             gt-label="查询，服务调用和分析数据 (1&nbsp;分钟&nbsp;聚合)"
             gt-model="config.rollupCappedDatabaseSizesMb[0]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="MB"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8"
             class="gt-rollup-capped-database-size">
          <div class="help-block">
            在事务查询，服务调用和连续分析选项卡下显示的数据被连续收集并以1分钟的间隔存储。 此设置定义保留这些1分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="查询，服务调用和分析数据 (5&nbsp;分钟&nbsp;聚合)"
             gt-model="config.rollupCappedDatabaseSizesMb[1]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="MB"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询，服务调用和连续分析数据以5分钟的间隔汇总。此设置定义用于存储这5分钟聚合的上限数据文件的大小。
          </div>
        </div>
        <div gt-form-group
             gt-label="查询，服务调用和分析数据 (30&nbsp;分钟&nbsp;聚合)"
             gt-model="config.rollupCappedDatabaseSizesMb[2]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="MB"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询，服务调用和连续分析数据以30分钟的间隔再次汇总。此设置定义用于存储这30分钟聚合的上限数据文件的大小。
          </div>
        </div>
        <div gt-form-group
             gt-label="查询，服务调用和分析数据 (4&nbsp;小时&nbsp;聚合)"
             gt-model="config.rollupCappedDatabaseSizesMb[3]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="MB"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询，服务调用和连续分析数据每隔4小时再次汇总。此设置定义用于存储这些4小时聚合的上限数据文件的大小。
          </div>
        </div>
        <div gt-form-group
             gt-label="跟踪详细数据"
             gt-model="config.traceCappedDatabaseSizeMb"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="MB"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8"
             class="gt-trace-capped-database-size">
          <div class="help-block">
            此设置定义用于存储跟踪详细信息数据（跟踪条目，跟踪查询统计信息和跟踪配置文件）的上限数据文件的大小。
          </div>
        </div>
      </fieldset>
      <fieldset class="gt-fieldset"
                ng-if="layout.central">
        <legend class="gt-legend">
          响应时间和JVM指标数据
        </legend>
        <div gt-form-group
             gt-label="1&nbsp;分钟&nbsp;聚合"
             gt-model="page.rollupExpirationDays[0]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            在事务响应时间选项卡下和JVM指标屏幕上显示的数据由代理程序连续收集，并以1分钟的间隔发送到中央收集器（并存储）。此设置定义保留这些1分钟聚合的时间。 （此设置也适用于5秒计量数据）
          </div>
        </div>
        <div gt-form-group
             gt-label="5&nbsp;分钟&nbsp;聚合"
             gt-model="page.rollupExpirationDays[1]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔5分钟汇总一次。此设置定义保留这5分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="30&nbsp;分钟&nbsp;聚合"
             gt-model="page.rollupExpirationDays[2]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔30分钟再次汇总。此设置定义保留这30分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="4&nbsp;小时&nbsp;聚合"
             gt-model="page.rollupExpirationDays[3]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            响应时间和JVM指标数据每隔4小时再次汇总。此设置定义保留这4小时聚合的时间。
          </div>
        </div>
      </fieldset>
      <fieldset class="gt-fieldset"
                ng-if="layout.central">
        <legend class="gt-legend">
          查询和服务调用数据
        </legend>
        <div gt-form-group
             gt-label="1&nbsp;分钟&nbsp;聚合"
             gt-model="page.queryAndServiceCallRollupExpirationDays[0]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            代理连续收集事务查询和服务调用选项卡下显示的数据，并以1分钟的间隔发送到中央收集器（并存储）。此设置定义保留这些1分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="5&nbsp;分钟&nbsp;聚合"
             gt-model="page.queryAndServiceCallRollupExpirationDays[1]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询和服务呼叫数据每隔5分钟汇总一次。此设置定义保留这5分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="30&nbsp;分钟&nbsp;聚合"
             gt-model="page.queryAndServiceCallRollupExpirationDays[2]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询和服务呼叫数据每隔30分钟再次汇总。此设置定义保留这30分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="4&nbsp;小时&nbsp;聚合"
             gt-model="page.queryAndServiceCallRollupExpirationDays[3]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            查询和服务呼叫数据每隔4小时再次汇总。此设置定义保留这4小时聚合的时间。
          </div>
        </div>
      </fieldset>
      <fieldset class="gt-fieldset"
                ng-if="layout.central">
        <legend class="gt-legend">
          分析数据
        </legend>
        <div gt-form-group
             gt-label="1&nbsp;分钟&nbsp;聚合"
             gt-model="page.profileRollupExpirationDays[0]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            在事务连续性能分析选项卡下显示的数据由代理连续收集并以1分钟的间隔发送到中央收集器（并存储）。此设置定义保留这些1分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="5&nbsp;分钟&nbsp;聚合"
             gt-model="page.profileRollupExpirationDays[1]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            配置文件数据每隔5分钟汇总一次。此设置定义保留这5分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="30&nbsp;分钟&nbsp;聚合"
             gt-model="page.profileRollupExpirationDays[2]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            每隔30分钟再次汇总配置文件数据。此设置定义保留这些30分钟聚合的时间。
          </div>
        </div>
        <div gt-form-group
             gt-label="4&nbsp;小时&nbsp;聚合"
             gt-model="page.profileRollupExpirationDays[3]"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            每隔4小时再次汇总配置文件数据。此设置定义保留这些4小时聚合的时间。
          </div>
        </div>
      </fieldset>
      <fieldset class="gt-fieldset"
                ng-if="layout.central">
        <legend class="gt-legend">
          跟踪数据
        </legend>
        <div gt-form-group
             gt-label="跟踪数据"
             gt-model="page.traceExpirationDays"
             gt-number="true"
             gt-pattern="pattern.integer"
             gt-required="loaded"
             gt-disabled="!layout.adminEdit"
             gt-width="7em"
             gt-addon="天"
             gt-col-class1="col-xl-4"
             gt-col-class2="col-xl-8">
          <div class="help-block">
            此设置定义保留跟踪数据的时间。 这包括单个跟踪和错误消息数据。
          </div>
        </div>
      </fieldset>
      <div class="form-group row gt-form-buttons-below-fieldset"
           ng-if="layout.adminEdit || layout.offlineViewer">
        <div class="offset-xl-4 col-xl-8">
          <div gt-button-group>
            <div gt-button
                 gt-label="保存更改"
                 gt-click="save(deferred)"
                 gt-validate-form="formCtrl"
                 ng-if="layout.adminEdit"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="更新TWCS窗口大小"
                 gt-click="updateCassandraTwcsWindowSizes(deferred)"
                 gt-btn-class="btn-secondary"
                 gt-dont-validate-form="true"
                 gt-confirm-header="更新TWCS窗口大小？"
                 gt-confirm-body="这可能会触发很多窗口主要的压缩。"
                 ng-if="layout.adminEdit && layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="整理H2数据"
                 gt-click="defragH2Data(deferred)"
                 gt-btn-class="btn-secondary"
                 gt-dont-validate-form="true"
                 gt-confirm-header="整理H2数据"
                 gt-confirm-body="这可能需要几分钟，具体取决于H2数据文件大小，在此期间监控平台将不会捕获任何新数据。"
                 ng-if="layout.adminEdit && !layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="压缩H2数据"
                 gt-click="compactH2Data(deferred)"
                 gt-btn-class="btn-secondary"
                 gt-dont-validate-form="true"
                 gt-confirm-header="压缩H2数据？"
                 gt-confirm-body="这可能需要几分钟，具体取决于H2数据文件大小，在此期间监控平台将不会捕获任何新数据。"
                 ng-if="layout.adminEdit && !layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="分析H2磁盘空间"
                 gt-click="analyzeH2DiskSpace(deferred)"
                 gt-btn-class="btn-secondary"
                 gt-dont-validate-form="true"
                 gt-confirm-header="分析H2磁盘空间？"
                 gt-confirm-body="这可能需要几分钟，具体取决于H2数据文件大小，在此期间监控平台数据捕获将受到影响。"
                 ng-if="layout.adminEdit && !layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="分析跟踪总数"
                 gt-click="analyzeTraceCounts(deferred)"
                 gt-btn-class="btn-secondary"
                 gt-dont-validate-form="true"
                 gt-confirm-header="分析跟踪总数？"
                 gt-confirm-body="这可能需要几分钟，具体取决于跟踪的数量，在此期间监控平台数据捕获将受到影响。"
                 ng-if="layout.adminEdit && !layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="删除所有数据"
                 gt-click="deleteAllStoredData(deferred)"
                 gt-btn-class="btn-danger"
                 gt-dont-validate-form="true"
                 gt-confirm-header="删除所有数据？"
                 gt-confirm-body="这将删除所有捕获的数据，包括聚合的事务数据，跟踪和计量数据。"
                 ng-if="layout.adminEdit && !layout.central"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="整理H2数据"
                 gt-click="defragH2Data(deferred)"
                 gt-btn-class="btn-secondary"
                 ng-if="layout.offlineViewer"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="压缩H2数据"
                 gt-click="compactH2Data(deferred)"
                 gt-btn-class="btn-secondary"
                 ng-if="layout.offlineViewer"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="分析H2磁盘空间"
                 gt-click="analyzeH2DiskSpace(deferred)"
                 gt-btn-class="btn-secondary"
                 ng-if="layout.offlineViewer"
                 class="d-inline-block">
            </div>
            <div gt-button
                 gt-label="分析跟踪计数"
                 gt-click="analyzeTraceCounts(deferred)"
                 gt-btn-class="btn-secondary"
                 ng-if="layout.offlineViewer"
                 class="d-inline-block">
            </div>
          </div>
          <div class="help-block" ng-if="layout.central">
            更新的到期设置仅适用于从此时收集的数据。 由于使用<a href="https://docs.datastax.com/en/cql/3.1/cql/cql_using/use_expire_c.html">Cassandra TTL</a>实现过期，因此在捕获数据时，现有数据仍使用有效的过期设置进行标记。
          </div>
          <div class="help-block" ng-if="layout.central">
            <a href="http://cassandra.apache.org/doc/latest/operating/compaction.html#time-window-compactionstrategy">
              Cassandra TWCS</a> 窗口大小是使用表格的TTL除以24计算的，因此该表格将有大约24个窗口。
          </div>
        </div>
      </div>
      <div ng-if="showH2DiskSpaceAnalysis">
        <div style="margin-top: 40px;">
          <span style="font-weight: bold; margin-left: 8px;">H2数据文件大小:</span> {{h2DataFileSize | gtBytes}}
        </div>
        <table class="table"
               style="table-layout: fixed; margin-top: 30px;">
          <thead>
          <tr>
            <th style="width: 50%;">
              表名
            </th>
            <th style="width: 25%;">
              总字节数
            </th>
            <th style="width: 25%;">
              行数
            </th>
          </tr>
          </thead>
          <tbody>
          <tr ng-repeat="analyzedH2Table in analyzedH2Tables">
            <td>
              {{analyzedH2Table.name}}
            </td>
            <td>
              {{analyzedH2Table.bytes | number}}
            </td>
            <td>
              {{analyzedH2Table.rows | number}}
            </td>
          </tr>
          </tbody>
        </table>
      </div>
      <div ng-if="showTraceCountAnalysis">
        <table class="table"
               style="table-layout: fixed; margin-top: 40px;"
               ng-if="analyzedTraceOverallCounts.length > 1">
          <thead>
          <tr style="padding-top: 10px;">
            <th colspan="3" style="font-size: 18px; font-weight: 600; text-align: center;">按事务类型</th>
          </tr>
          <tr>
            <th>
              事务类型
            </th>
            <th>
              捕获的跟踪
            </th>
            <th>
              捕获的跟踪是因为它们被标记为错误
            </th>
          </tr>
          </thead>
          <tbody>
          <tr ng-repeat="analyzedTraceOverallCount in analyzedTraceOverallCounts">
            <td>
              {{analyzedTraceOverallCount.transactionType}}
            </td>
            <td>
              {{analyzedTraceOverallCount.count | number}}
            </td>
            <td>
              {{analyzedTraceOverallCount.errorCount | number}}
            </td>
          </tr>
          </tbody>
        </table>
        <table class="table"
               style="table-layout: fixed; margin-top: 40px;">
          <thead>
          <tr ng-if="analyzedTraceOverallCounts.length > 1">
            <th colspan="4" style="font-size: 18px; font-weight: 600; text-align: center;">按事务名称</th>
          </tr>
          <tr>
            <th style="width: 20%;">
              事务类型
            </th>
            <th style="width: 40%;">
              事务名称
            </th>
            <th style="width: 20%;">
              捕获的跟踪
            </th>
            <th style="width: 20%;">
              捕获的跟踪是因为它们被标记为错误
            </th>
          </tr>
          </thead>
          <tbody>
          <tr ng-repeat="analyzedTraceCount in analyzedTraceCounts">
            <td>
              {{analyzedTraceCount.transactionType}}
            </td>
            <td class="gt-break-word">
              {{analyzedTraceCount.transactionName}}
            </td>
            <td>
              {{analyzedTraceCount.count | number}}
            </td>
            <td>
              {{analyzedTraceCount.errorCount | number}}
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<!-- each page with confirmation dialog needs its own confirmation dom so that it is deleted on $destroy -->
<div ng-include="'template/gt-confirmation.html'"></div>
